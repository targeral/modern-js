"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[4906],{44993:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>m});var i=n(52983);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),p=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},u=function(e){var t=p(e.components);return i.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},c=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),m=a,f=c["".concat(s,".").concat(m)]||c[m]||d[m]||r;return n?i.createElement(f,o(o({ref:t},u),{},{components:n})):i.createElement(f,o({ref:t},u))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var p=2;p<r;p++)o[p]=n[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}c.displayName="MDXCreateElement"},40015:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>l,toc:()=>p});var i=n(18249),a=(n(52983),n(44993));const r={sidebar_position:1,title:"Integration"},o=void 0,l={unversionedId:"guides/advanced-features/bff/function",id:"guides/advanced-features/bff/function",title:"Integration",description:"Modern.js allow functions that meet certain conditions in the api/ directory to be directly called in the React component, which is called integration.",source:"@site/../../packages/toolkit/main-doc/en/docusaurus-plugin-content-docs/current/guides/advanced-features/bff/function.md",sourceDirName:"guides/advanced-features/bff",slug:"/guides/advanced-features/bff/function",permalink:"/v2/en/docs/guides/advanced-features/bff/function",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_position:1,title:"Integration"},sidebar:"guidesSidebar",previous:{title:"BFF",permalink:"/v2/en/docs/guides/advanced-features/bff/"},next:{title:"Writing Type",permalink:"/v2/en/docs/guides/advanced-features/bff/type"}},s={},p=[{value:"BFF Function",id:"bff-function",level:2},{value:"Function Route",id:"function-route",level:2},{value:"Default Route",id:"default-route",level:3},{value:"Multi-layer Route",id:"multi-layer-route",level:3},{value:"Dynamic Route",id:"dynamic-route",level:3},{value:"Allow List",id:"allow-list",level:3},{value:"RESTful API",id:"restful-api",level:2},{value:"Function Named Export",id:"function-named-export",level:3},{value:"Function Parameter Rule",id:"function-parameter-rule",level:3},{value:"Dynamic Path",id:"dynamic-path",level:4},{value:"RequestOption",id:"requestoption",level:4}],u={toc:p};function d(e){let{components:t,...n}=e;return(0,a.kt)("wrapper",(0,i.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Modern.js allow functions that meet certain conditions in the ",(0,a.kt)("inlineCode",{parentName:"p"},"api/")," directory to be directly called in the React component, which is called ",(0,a.kt)("strong",{parentName:"p"},"integration"),"."),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"The use of integration calls requires the enable BFF first.")),(0,a.kt)("h2",{id:"bff-function"},"BFF Function"),(0,a.kt)("p",null,"The functions that are allowed to be called through integration are called ",(0,a.kt)("strong",{parentName:"p"},"BFF functions"),". Here is the simplest BFF function to write, creating an ",(0,a.kt)("inlineCode",{parentName:"p"},"api/hello.ts")," file:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="api/hello.ts"',title:'"api/hello.ts"'},"export const get = async () => 'Hello Modern.js';\n")),(0,a.kt)("p",null,"Then directly import the function in ",(0,a.kt)("inlineCode",{parentName:"p"},"src/App.tsx")," and call:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-tsx",metastring:"title=src/App.tsx",title:"src/App.tsx"},"import { useState, useEffect } from 'react';\nimport { get as hello } from '@api/hello';\n\nexport default () => {\n  const [text, setText] = useState('');\n\n  useEffect(() => {\n    hello().then(setText);\n  }, []);\n  return <div>{text}</div>;\n};\n")),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Modern.js generator has already configured the ",(0,a.kt)("inlineCode",{parentName:"p"},"@api")," alias in tsconfig.json, so you can import functions directly by aliases.")),(0,a.kt)("p",null,"The functions import in ",(0,a.kt)("inlineCode",{parentName:"p"},"src/App.tsx")," will be automatically converted into interface calls, so there is no need to call the interface through fetch."),(0,a.kt)("p",null,"Execute ",(0,a.kt)("inlineCode",{parentName:"p"},"pnpm run dev"),", then open ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:8080/")," to see that the page has displayed the content returned by the BFF function. In Network, you can see that the page sent a request to ",(0,a.kt)("inlineCode",{parentName:"p"},"http://localhost:8080/api/hello"),"."),(0,a.kt)("h2",{id:"function-route"},"Function Route"),(0,a.kt)("p",null,"In Modern.js, the BFF function routing system is implemented based on the file system, and it is also a conventional routing system."),(0,a.kt)("p",null,"In ",(0,a.kt)("strong",{parentName:"p"},"Function Writing"),", All files under ",(0,a.kt)("inlineCode",{parentName:"p"},"api/")," will map to an interface. In ",(0,a.kt)("strong",{parentName:"p"},"Framework Writing"),", All files under ",(0,a.kt)("inlineCode",{parentName:"p"},"api/lambda")," will map to an interface"),(0,a.kt)("admonition",{type:"note"},(0,a.kt)("p",{parentName:"admonition"},"Function Writing & Framework Writing will introduce soon.")),(0,a.kt)("p",null,"All routes generated by BFF functions have a prefix, and the default value is ",(0,a.kt)("inlineCode",{parentName:"p"},"/api"),". The prefix can be set through ","[bff.prefix]"," (/docs/configure/app/bff/prefix)."),(0,a.kt)("p",null,"Several routing conventions are described as follow."),(0,a.kt)("h3",{id:"default-route"},"Default Route"),(0,a.kt)("p",null,"Files named ",(0,a.kt)("inlineCode",{parentName:"p"},"index.[jt]s")," are mapped to the previous directory."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"api/index.ts")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"{prefix}/")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"api/user/index.ts")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"{prefix}/user"))),(0,a.kt)("h3",{id:"multi-layer-route"},"Multi-layer Route"),(0,a.kt)("p",null,"Supports parsing nested files, if you create a nested folder structure, the files will still automatically parse routes in the same way."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"api/hello.ts")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"{prefix}/hello")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"api/user/list.ts")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"{prefix}/user/list"))),(0,a.kt)("h3",{id:"dynamic-route"},"Dynamic Route"),(0,a.kt)("p",null,"Create folders or files named with ",(0,a.kt)("inlineCode",{parentName:"p"},"[xxx]")," to support dynamic named routing parameters."),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"api/user/[username]/info.ts")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"{prefix}/user/:username/info")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"api/user/username/[action].ts")," -> ",(0,a.kt)("inlineCode",{parentName:"li"},"{prefix}/user/username/:action"))),(0,a.kt)("h3",{id:"allow-list"},"Allow List"),(0,a.kt)("p",null,"By default, all files in the'api/'directory will be parsed as BFF function files, but the following files will not be parsed:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"file name start with ",(0,a.kt)("inlineCode",{parentName:"li"},"_"),", for example ",(0,a.kt)("inlineCode",{parentName:"li"},"_utils.ts"),"."),(0,a.kt)("li",{parentName:"ul"},"files in directory which name start with ",(0,a.kt)("inlineCode",{parentName:"li"},"_"),", for example ",(0,a.kt)("inlineCode",{parentName:"li"},"_utils/index.ts"),"\u3001",(0,a.kt)("inlineCode",{parentName:"li"},"_utils/cp.ts"),"."),(0,a.kt)("li",{parentName:"ul"},"test files, for example ",(0,a.kt)("inlineCode",{parentName:"li"},"foo.test.ts"),"."),(0,a.kt)("li",{parentName:"ul"},"type files, for example ",(0,a.kt)("inlineCode",{parentName:"li"},"hello.d.ts"),"."),(0,a.kt)("li",{parentName:"ul"},"files in ",(0,a.kt)("inlineCode",{parentName:"li"},"node_module"),".")),(0,a.kt)("h2",{id:"restful-api"},"RESTful API"),(0,a.kt)("p",null,"Modern.js BFF functions need to be defined according to the RESTful API standard, follow the HTTP Method specification, and do not allow free parameter definition."),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"Assuming that the function allows free definition of parameters, the resulting route must be called by the ",(0,a.kt)("strong",{parentName:"p"},"private protocol")," (the reason is that the request parameters cannot be distinguished from the request body), and cannot implement any RESTful API."),(0,a.kt)("p",{parentName:"admonition"},"If the service is only used for the application itself, there is no problem. but its ",(0,a.kt)("strong",{parentName:"p"},"non-standard interface definition")," cannot be integrated into the larger system. In the case of multiple systems working together (such as BFF low-code construction), other systems also need to follow the ",(0,a.kt)("strong",{parentName:"p"},"private protocol"),".")),(0,a.kt)("h3",{id:"function-named-export"},"Function Named Export"),(0,a.kt)("p",null,"Modern.js the export name of the BFF function determines the Method of the corresponding interface of the function, such as ",(0,a.kt)("inlineCode",{parentName:"p"},"get"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"post")," and so on."),(0,a.kt)("p",null,"For example, following the example, a ",(0,a.kt)("inlineCode",{parentName:"p"},"GET")," interface can be exported."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export const get = async () => {\n  return {\n    name: 'Modern.js',\n    desc: '\u73b0\u4ee3 web \u5de5\u7a0b\u65b9\u6848',\n  };\n};\n")),(0,a.kt)("p",null,"Following the example below, a ",(0,a.kt)("inlineCode",{parentName:"p"},"POST")," interface can be exported."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts"},"export const post = async () => {\n  return {\n    name: 'Modern.js',\n    desc: '\u73b0\u4ee3 web \u5de5\u7a0b\u65b9\u6848',\n  };\n};\n")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Modern.js supports 9 definitions for HTTP Method: ",(0,a.kt)("inlineCode",{parentName:"p"},"GET"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"POST"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"PUT"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"DELETE"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"CONNECT"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"TRACE"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"PATCH"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"OPTION"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"HEAD"),", can be exported using these methods as functions\u3002")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"The name is size insensitive\uff0cif ",(0,a.kt)("inlineCode",{parentName:"p"},"GET"),"\uff0ccan write ",(0,a.kt)("inlineCode",{parentName:"p"},"get"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"Get"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"GEt"),"\u3001",(0,a.kt)("inlineCode",{parentName:"p"},"GET"),"\uff0ccan be accurately identified. But default export as ",(0,a.kt)("inlineCode",{parentName:"p"},"export default xxx")," will be map to ",(0,a.kt)("inlineCode",{parentName:"p"},"Get"),"\u3002")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"Multiple functions of different Methods can be defined in one file, but if multiple functions of the same Method are defined, only the first will take effect."))),(0,a.kt)("admonition",{type:"info"},(0,a.kt)("p",{parentName:"admonition"},"It should be noted that the defined functions should all be asynchronous, which is related to the type when the function is called, which will be mentioned later.")),(0,a.kt)("h3",{id:"function-parameter-rule"},"Function Parameter Rule"),(0,a.kt)("p",null,"As mentioned above, in order to meet the design criteria of RESTful APIs, the BFF function in Modern.js needs to follow certain imported parameter rules."),(0,a.kt)("p",null,"The function parameters are divided into two parts, the dynamic part in the request path and the request option ",(0,a.kt)("inlineCode",{parentName:"p"},"RequestOption"),"."),(0,a.kt)("h4",{id:"dynamic-path"},"Dynamic Path"),(0,a.kt)("p",null,"Dynamic routing will be used as imported parameters in the first part of the function, and each imported parameter corresponds to a dynamic route. For example, in the following example, uid will be passed into the function as the first two parameters:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="api/[level]/[id].ts"',title:'"api/[level]/[id].ts"'},"export default async (level: number, id: number) => {\n  const userData = await queryUser(level, uid);\n  return userData\n}\n")),(0,a.kt)("p",null,"Pass dynamic parameters directly when calling:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="App.tsx"',title:'"App.tsx"'},"import { useState, useEffect } from 'react'\nimport { get as getUser } from '@api/[level]/[id]'\n\nexport default () => {\n  const [name, setName] = useState('')\n\n  useEffect(() => {\n    getUser(6, 001).then(\n      userData => setName(userData.name)\n    )\n  }, [])\n\n  return <div>{name}</div>\n}\n")),(0,a.kt)("h4",{id:"requestoption"},"RequestOption"),(0,a.kt)("p",null,"The parameter after Dynamic Path is the object ",(0,a.kt)("inlineCode",{parentName:"p"},"RequestOption")," containing querystring and request body, which is used to define the types of ",(0,a.kt)("inlineCode",{parentName:"p"},"data")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"query"),"."),(0,a.kt)("p",null,"In normal functions without dynamic routing, the incoming ",(0,a.kt)("inlineCode",{parentName:"p"},"data")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"query")," can be obtained from the first imported parameter, for example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="api/hello.ts"',title:'"api/hello.ts"'},"import type { RequestOption } from '@modern-js/runtime/server'\n\nexport async function post(\n  { query, data }: RequestOption<Record<string, string>, Record<string, string>>\n) {\n  // do somethings\n}\n")),(0,a.kt)("p",null,"When a function file uses dynamic routing rules, dynamic routing before the ",(0,a.kt)("inlineCode",{parentName:"p"},"RequestOption")," parameter."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="api/[sku]/[id]/item.ts"',title:'"api/[sku]/[id]/item.ts"'},"export async function post(\n  sku: string,\n  id: string,\n  { data, query }: RequestOption<Record<string, string>, Record<string, string>>\n) {\n  // do somethings\n}\n")),(0,a.kt)("p",null,"Also pass in the parameters according to the function definition:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-ts",metastring:'title="App.tsx"',title:'"App.tsx"'},"import { post } from '@api/[sku]/[id]/item'\n\nexport default () => {\n  const addSku = () => {\n    post('0001'/* sku */, '1234' /* id */, {\n      query: { /* ... */ },\n      data: { /* ... */ },\n    })\n  }\n\n  return <div onClick={addSku}>\u6dfb\u52a0 SKU</div>\n}\n")),(0,a.kt)("p",null,"As mentioned earlier, the defined functions should be asynchronous because they are automatically converted to HTTP interface calls when called by the front end."),(0,a.kt)("p",null,"so in order to keep the type definition consistent with the actual calling, it is necessary to set the BFF function to asynchronous when defining it."))}d.isMDXComponent=!0}}]);